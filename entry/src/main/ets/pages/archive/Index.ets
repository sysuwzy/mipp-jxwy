import { HealthRecord, HealthRecordType } from '../../models/HealthRecord';
import { prompt } from '@kit.ArkUI';
import { AuthorizationCode } from '../../models/AuthorizationCode';
import { StorageHelper } from '../../utils/StorageHelper';
import { common } from '@kit.AbilityKit';
interface GeneratedTypeLiteralInterface_1 {
  id: string;
  title: string;
  type: HealthRecordType;
  content: string;
  hospital: string;
  date: string;
  tags?: string[];
}
// åœ¨Indexç±»ä¸Šé¢æ·»åŠ æ¥å£å®šä¹‰
interface AuthCodeData {
  code?: string;
  recordIds?: string[];
  expireAt?: number;
  hospitalName?: string;
  createdAt?: number;
  used?: boolean;
}
interface OptionType {
  label: string;
  value: string;
}
@Entry
@Component
export struct Index {
  @State currentTab: number = 0;
  @State archiveList: HealthRecord[] = [];
  @State selectedArchive: HealthRecord | null = null;

  @State editTitle: string = '';
  @State editType:  string = '';
  @State editHospital: string = '';
  @State editDate: string = '';
  @State editContent: string = '';

  // ============ æ–°å¢ï¼šåŠ å¯†åˆ†äº«ç›¸å…³çŠ¶æ€ ============
  @State showShareDialog: boolean = false;
  @State shareCode: string = '';
  @State shareExpireTime: string = '';
  @State authorizationCodes: AuthorizationCode[] = []; // å­˜å‚¨ç”Ÿæˆçš„æˆæƒç 
  
  // ============ ä¸‹æ‹‰åˆ·æ–°ç›¸å…³çŠ¶æ€ ============
  @State isRefreshing: boolean = false;
  
  // ============ æˆæƒç ç®¡ç†ç›¸å…³çŠ¶æ€ ============
  @State showAuthCodeDialog: boolean = false;

  private readonly typeOptions: OptionType[] = [
    { label: 'é—¨è¯Šç—…å†', value: 'é—¨è¯Šç—…å†' },
    { label: 'æ£€æŸ¥æŠ¥å‘Š', value: 'æ£€æŸ¥æŠ¥å‘Š' },
    { label: 'ç”¨è¯å¤„æ–¹', value: 'ç”¨è¯å¤„æ–¹' },
    { label: 'ä¸“é¡¹æ¡£æ¡ˆ', value: 'ä¸“é¡¹æ¡£æ¡ˆ' },
    { label: 'å…¶ä»–', value: 'å…¶ä»–' }
  ];
  // åˆ›å»ºå¥åº·è®°å½•å·¥å‚å‡½æ•°
  private createHealthRecord(data: GeneratedTypeLiteralInterface_1): HealthRecord {
    const record = new HealthRecord();
    record.id = data.id;
    record.title = data.title;
    record.type = data.type;
    record.content = data.content;
    record.hospital = data.hospital;
    record.date = data.date;
    record.tags = data.tags || [];
    return record;
  }

  // æ¨¡æ‹Ÿæ•°æ®
  private mockData: HealthRecord[] = [
    this.createHealthRecord({
      id: '1',
      title: '2024å¹´åº¦ä½“æ£€æŠ¥å‘Š',
      type: HealthRecordType.EXAMINATION,
      content: 'ä½“æ£€ç»“æœæ­£å¸¸ï¼Œå„é¡¹æŒ‡æ ‡è‰¯å¥½ã€‚',
      hospital: 'åŒ—äº¬åå’ŒåŒ»é™¢',
      date: '2024-10-15',
      tags: ['å¹´åº¦ä½“æ£€', 'é‡è¦']
    }),
    this.createHealthRecord({
      id: '2',
      title: 'é—¨è¯Šå°±è¯Šè®°å½•',
      type: HealthRecordType.OUTPATIENT,
      content: 'æ„Ÿå†’å°±è¯Šï¼Œå¼€å…·æŠ—ç”Ÿç´ ã€‚',
      hospital: 'ä¸Šæµ·å¸‚ç¬¬ä¸€äººæ°‘åŒ»é™¢',
      date: '2024-09-20',
      tags: ['é—¨è¯Š', 'æ„Ÿå†’']
    }),
    this.createHealthRecord({
      id: '3',
      title: 'å¼‚åœ°å°±åŒ»ä¸“é¡¹æ¡£æ¡ˆ',
      type: HealthRecordType.SPECIAL_ARCHIVE,
      content: 'æ•´åˆå¼‚åœ°å°±åŒ»å…¨éƒ¨è®°å½•ã€‚',
      hospital: 'å¼‚åœ°å°±åŒ»æ¡£æ¡ˆ',
      date: '2024-11-01',
      tags: ['å¼‚åœ°å°±åŒ»', 'å¿…å¤‡']
    })
  ];

  async aboutToAppear() {
    // åˆå§‹åŒ–å­˜å‚¨
    const context = getContext(this) as common.UIAbilityContext;
    await StorageHelper.init(context);
    
    // ä»æœ¬åœ°åŠ è½½æ•°æ®
    const savedArchives: HealthRecord[] = await StorageHelper.loadArchiveList();
    const savedCodes: AuthorizationCode[] = await StorageHelper.loadAuthorizationCodes();
    
    if (savedArchives.length > 0) {
      // å¦‚æœæœ‰ä¿å­˜çš„æ•°æ®ï¼Œä½¿ç”¨ä¿å­˜çš„æ•°æ®
      this.archiveList = savedArchives;
    } else {
      // å¦‚æœæ²¡æœ‰ä¿å­˜çš„æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆé¦–æ¬¡å¯åŠ¨ï¼‰
      this.archiveList = this.mockData;
      // ä¿å­˜åˆå§‹æ•°æ®
      await StorageHelper.saveArchiveList(this.archiveList);
    }
    
    // åŠ è½½æˆæƒç 
    if (savedCodes.length > 0) {
      this.authorizationCodes = savedCodes;
    }
  }

  // åˆ›å»ºæ–°æ¡£æ¡ˆ
  async createNewArchive() {
    const newRecord = this.createHealthRecord({
      id: `record_${Date.now()}`,
      title: 'æ–°å»ºå¥åº·æ¡£æ¡ˆ',
      type: HealthRecordType.OTHER,
      content: 'è¯·åœ¨æ­¤ç¼–è¾‘æ¡£æ¡ˆå†…å®¹ã€‚',
      hospital: 'è¯·å¡«å†™åŒ»é™¢',
      date: new Date().toISOString().split('T')[0],
      tags: ['æ–°åˆ›å»º']
    });

    this.archiveList = [newRecord, ...this.archiveList];
    // ä¿å­˜åˆ°æœ¬åœ°
    await StorageHelper.saveArchiveList(this.archiveList);
    prompt.showToast({ message: 'æ–°å»ºæ¡£æ¡ˆæˆåŠŸ', duration: 2000 });
  }

  // æŸ¥çœ‹æ¡£æ¡ˆè¯¦æƒ…
  viewArchiveDetail(record: HealthRecord) {
    this.selectedArchive = record;
    this.currentTab = 1;
  }

  // åˆ é™¤æ¡£æ¡ˆ
  async deleteArchive(id: string) {
    this.archiveList = this.archiveList.filter(item => item.id !== id);
    if (this.selectedArchive?.id === id) {
      this.selectedArchive = null;
      this.currentTab = 0;
    }
    // ä¿å­˜åˆ°æœ¬åœ°
    await StorageHelper.saveArchiveList(this.archiveList);
    prompt.showToast({ message: 'åˆ é™¤æˆåŠŸ', duration: 2000 });
  }

  // è¿”å›åˆ—è¡¨
  backToList() {
    this.currentTab = 0;
    this.selectedArchive = null;
  }

  build() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜æ ï¼ˆä¿æŒä¸å˜ï¼‰
      Row() {
        Text('å¥åº·æ¡£æ¡ˆ')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .margin({ left: 16 })

        Blank()

        if (this.currentTab === 1) {
          Text('è¿”å›')
            .fontSize(16)
            .fontColor(Color.White)
            .margin({ right: 16 })
            .onClick(() => this.backToList())
        }
      }
      .width('100%')
      .height(60)
      .backgroundColor('#5FCCC4')

      // ä¸»å†…å®¹åŒºåŸŸ
      if (this.currentTab === 0) {
        this.buildArchiveList()
      } else if (this.currentTab === 1 && this.selectedArchive) {
        this.buildArchiveDetail()
      } else if (this.currentTab === 2 && this.selectedArchive) {
        this.buildEditPage()
      }

      // ============ æ–°å¢ï¼šåˆ†äº«å¼¹çª— ============
      if (this.showShareDialog) {
        this.buildShareDialog()
      }

      // ============ æˆæƒç ç®¡ç†å¼¹çª— ============
      if (this.showAuthCodeDialog) {
        this.buildAuthCodeDialog()
      }
    }
    .width('100%')
    .height('100%')
  }

  @Builder
  buildArchiveList() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Row() {
        Column() {
          Text(`${this.archiveList.length} æ¡è®°å½•`)
            .fontSize(14)
            .fontColor('#999')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        Blank()
      }
      .width('100%')
      .padding({ left: 20, right: 20, top: 16, bottom: 16 })

      if (this.archiveList.length === 0) {
        Column() {
          Text('ğŸ“‚')
            .fontSize(80)
            .margin({ bottom: 24 })
          Text('æš‚æ— å¥åº·æ¡£æ¡ˆ')
            .fontSize(20)
            .fontWeight(FontWeight.Medium)
            .fontColor('#333')
            .margin({ bottom: 8 })
          Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªæ¡£æ¡ˆ')
            .fontSize(14)
            .fontColor('#999')
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
      } else {
        // ä½¿ç”¨Refreshç»„ä»¶å®ç°ä¸‹æ‹‰åˆ·æ–°
        Refresh({ 
          offset: 72, 
          friction: 100, 
          builder: this.refreshBuilder,
          refreshing: this.isRefreshing
        }) {
          List() {
            ForEach(this.archiveList, (item: HealthRecord, index: number) => {
              ListItem() {
                this.buildArchiveCard(item, index)
              }
            }, (item: HealthRecord) => item.id)
          }
          .width('100%')
          .layoutWeight(1)
          .divider({ strokeWidth: 0 })
          .padding({ left: 16, right: 16, bottom: 100 })
        }
        .onRefreshing(() => {
          this.handleRefresh();
        })
        .layoutWeight(1)
      }

      // åº•éƒ¨æ“ä½œæŒ‰é’®åŒºåŸŸ - å›ºå®šåœ¨åº•éƒ¨
      Column() {
        Row() {
          Button('+ æ–°å»ºæ¡£æ¡ˆ', { type: ButtonType.Capsule })
            .layoutWeight(1)
            .height(50)
            .backgroundColor('#5FCCC4')
            .fontColor(Color.White)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .onClick(() => this.createNewArchive())

          Button('æŸ¥çœ‹æˆæƒç ', { type: ButtonType.Capsule })
            .layoutWeight(1)
            .height(50)
            .backgroundColor('#FF9800')
            .fontColor(Color.White)
            .fontSize(16)
            .fontWeight(FontWeight.Medium)
            .margin({ left: 12 })
            .onClick(() => this.viewAuthorizationCodes())
        }
        .width('100%')
        .padding({ left: 20, right: 20 })
      }
      .width('100%')
      .padding({ top: 12, bottom: 80 })
      .backgroundColor('#F5F5F5')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }

  // æ„å»ºæ¡£æ¡ˆå¡ç‰‡
  @Builder
  buildArchiveCard(item: HealthRecord, index: number) {
    Column() {
      Row() {
        // å·¦ä¾§å›¾æ ‡åŒºåŸŸ
        Column() {
          Text(this.getTypeIcon(item.type))
            .fontSize(36)
        }
        .width(72)
        .height(72)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.getTypeColor(item.type))
        .borderRadius(14)

        // ä¸­é—´å†…å®¹åŒºåŸŸ
        Column() {
          Text(item.title)
            .fontSize(19)
            .fontWeight(FontWeight.Medium)
            .fontColor('#1A1A1A')
            .maxLines(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ bottom: 10 })

          Row() {
            Text(item.hospital)
              .fontSize(14)
              .fontColor('#666')
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })
            Text(' â€¢ ')
              .fontSize(14)
              .fontColor('#999')
            Text(item.date)
              .fontSize(14)
              .fontColor('#666')
          }
          .width('100%')
          .margin({ bottom: 10 })

          // æ ‡ç­¾åŒºåŸŸ
          if (item.tags && item.tags.length > 0) {
            Flex({ wrap: FlexWrap.Wrap }) {
              ForEach(item.tags.slice(0, 3), (tag: string) => {
                Text(tag)
                  .fontSize(11)
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .backgroundColor('#E3F2FD')
                  .fontColor('#1976D2')
                  .borderRadius(10)
                  .margin({ right: 6, bottom: 4 })
              })
            }
          }
        }
        .layoutWeight(1)
        .margin({ left: 20 })
        .alignItems(HorizontalAlign.Start)

        // å³ä¾§ç®­å¤´
        Text('â€º')
          .fontSize(28)
          .fontColor('#999')
          .fontWeight(FontWeight.Lighter)
      }
      .width('100%')
      .padding(20)
    }
    .width('100%')
    .backgroundColor(Color.White)
    .borderRadius(18)
    .margin({ bottom: 16 })
    .shadow({
      radius: 8,
      color: '#1F000000',
      offsetX: 0,
      offsetY: 2
    })
    .onClick(() => this.viewArchiveDetail(item))
  }

  // åˆ·æ–°æ„å»ºå™¨
  @Builder
  refreshBuilder() {
    Row() {
      if (this.isRefreshing) {
        LoadingProgress()
          .width(24)
          .height(24)
          .color('#5FCCC4')
        Text('æ­£åœ¨åˆ·æ–°...')
          .fontSize(14)
          .fontColor('#666')
          .margin({ left: 12 })
      } else {
        Text('ä¸‹æ‹‰åˆ·æ–°')
          .fontSize(14)
          .fontColor('#999')
      }
    }
    .width('100%')
    .height(56)
    .justifyContent(FlexAlign.Center)
  }

  // å¤„ç†åˆ·æ–°
  private async handleRefresh(): Promise<void> {
    this.isRefreshing = true;
    // é‡æ–°åŠ è½½æ•°æ®
    const savedArchives: HealthRecord[] = await StorageHelper.loadArchiveList();
    if (savedArchives.length > 0) {
      this.archiveList = savedArchives;
    }
    // æ¨¡æ‹Ÿåˆ·æ–°å»¶è¿Ÿ
    setTimeout(() => {
      this.isRefreshing = false;
    }, 1000);
  }

  // è·å–ç±»å‹é¢œè‰²
  private getTypeColor(type: string): string {
    if (type === 'é—¨è¯Šç—…å†') return '#E3F2FD';
    if (type === 'æ£€æŸ¥æŠ¥å‘Š') return '#F3E5F5';
    if (type === 'ç”¨è¯å¤„æ–¹') return '#FFF3E0';
    if (type === 'ä¸“é¡¹æ¡£æ¡ˆ') return '#E8F5E9';
    return '#F5F5F5';
  }

  @Builder
  buildArchiveDetail() {
    Scroll() {
      Column() {
        // æ¡£æ¡ˆåŸºæœ¬ä¿¡æ¯å¡ç‰‡
        Column() {
          // æ ‡é¢˜å’Œç±»å‹å›¾æ ‡
          Row() {
            Column() {
              Text(this.getTypeIcon(this.selectedArchive!.type))
                .fontSize(32)
            }
            .width(64)
            .height(64)
            .justifyContent(FlexAlign.Center)
            .backgroundColor(this.getTypeColor(this.selectedArchive!.type))
            .borderRadius(16)
            .margin({ right: 16 })

            Column() {
              Text(this.selectedArchive!.title)
                .fontSize(22)
                .fontWeight(FontWeight.Bold)
                .fontColor('#1A1A1A')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
                .margin({ bottom: 8 })

              Text(this.selectedArchive!.type)
                .fontSize(14)
                .fontColor('#666')
                .padding({ left: 12, right: 12, top: 4, bottom: 4 })
                .backgroundColor('#F0F0F0')
                .borderRadius(12)
            }
            .alignItems(HorizontalAlign.Start)
            .layoutWeight(1)
          }
          .width('100%')
          .margin({ bottom: 24 })

          // ä¿¡æ¯ç½‘æ ¼
          Row() {
            Column() {
              Text('ğŸ¥')
                .fontSize(20)
                .margin({ bottom: 8 })
              Text('åŒ»é™¢')
                .fontSize(12)
                .fontColor('#999')
                .margin({ bottom: 4 })
              Text(this.selectedArchive!.hospital)
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333')
                .maxLines(2)
                .textOverflow({ overflow: TextOverflow.Ellipsis })
            }
            .layoutWeight(1)
            .padding({ right: 12 })

            Column() {
              Text('ğŸ“…')
                .fontSize(20)
                .margin({ bottom: 8 })
              Text('æ—¥æœŸ')
                .fontSize(12)
                .fontColor('#999')
                .margin({ bottom: 4 })
              Text(this.selectedArchive!.date)
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333')
            }
            .layoutWeight(1)
          }
          .width('100%')
          .padding({ top: 16, bottom: 16 })
          .border({ width: 1, color: '#F0F0F0' })
          .borderRadius(12)
          .margin({ bottom: 20 })

          // æ“ä½œæŒ‰é’®
          Row() {
            Button('ç¼–è¾‘')
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#FF9800')
              .fontColor(Color.White)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .borderRadius(22)
              .onClick(() => this.enterEditMode(this.selectedArchive!))

            Button('åˆ†äº«')
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#5FCCC4')
              .fontColor(Color.White)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .borderRadius(22)
              .margin({ left: 12 })
              .onClick(() => this.shareArchive())

            Button('åˆ é™¤')
              .layoutWeight(1)
              .height(44)
              .backgroundColor('#F44336')
              .fontColor(Color.White)
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .borderRadius(22)
              .margin({ left: 12 })
              .onClick(() => this.deleteArchive(this.selectedArchive!.id))
          }
          .width('100%')
        }
        .width('100%')
        .padding(24)
        .backgroundColor(Color.White)
        .borderRadius(20)
        .margin({ top: 16, left: 16, right: 16 })
        .shadow({
          radius: 12,
          color: '#1F000000',
          offsetX: 0,
          offsetY: 4
        })

        // æ¡£æ¡ˆå†…å®¹å¡ç‰‡
        Column() {
          Row() {
            Text('ğŸ“„ æ¡£æ¡ˆå†…å®¹')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .fontColor('#1A1A1A')
            Blank()
            Button('ç¼–è¾‘')
              .fontSize(13)
              .height(32)
              .backgroundColor('#F0F0F0')
              .fontColor('#666')
              .borderRadius(16)
              .onClick(() => this.enterEditMode(this.selectedArchive!))
          }
          .width('100%')
          .margin({ bottom: 16 })

          Text(this.selectedArchive!.content || 'æš‚æ— å†…å®¹')
            .fontSize(15)
            .lineHeight(26)
            .fontColor('#333')
            .width('100%')
        }
        .width('100%')
        .padding(20)
        .backgroundColor(Color.White)
        .borderRadius(20)
        .margin({ top: 12, left: 16, right: 16, bottom: 20 })
        .shadow({
          radius: 12,
          color: '#1F000000',
          offsetX: 0,
          offsetY: 4
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
  @Builder
  buildEditPage() {
    Scroll() {
      Column() {
        // ç¼–è¾‘è¡¨å•å¡ç‰‡
        Column() {
          // æ ‡é¢˜
          Row() {
            Text('âœï¸ ç¼–è¾‘æ¡£æ¡ˆ')
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1A1A1A')
          }
          .width('100%')
          .margin({ bottom: 24 })

          // æ ‡é¢˜è¾“å…¥
          Column() {
            Text('æ ‡é¢˜')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333')
              .margin({ bottom: 10 })
            TextInput({
              text: this.editTitle,
              placeholder: 'è¯·è¾“å…¥æ¡£æ¡ˆæ ‡é¢˜'
            })
              .width('100%')
              .height(48)
              .padding({ left: 16, right: 16 })
              .backgroundColor('#F8F9FA')
              .borderRadius(12)
              .fontSize(15)
              .onChange((value: string) => {
                this.editTitle = value;
              })
          }
          .width('100%')
          .margin({ bottom: 20 })

          // ç±»å‹é€‰æ‹©
          Column() {
            Text('ç±»å‹')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333')
              .margin({ bottom: 10 })
            Flex({ wrap: FlexWrap.Wrap }) {
              ForEach(this.typeOptions, (option: OptionType) => {
                Text(option.label)
                  .fontSize(14)
                  .fontWeight(FontWeight.Medium)
                  .padding({ left: 20, right: 20, top: 10, bottom: 10 })
                  .backgroundColor(this.editType === option.value ? '#5FCCC4' : '#F0F0F0')
                  .fontColor(this.editType === option.value ? Color.White : '#666')
                  .borderRadius(24)
                  .margin({ right: 12, bottom: 12 })
                  .onClick(() => {
                    this.editType = option.value;
                  })
              })
            }
          }
          .width('100%')
          .margin({ bottom: 20 })

          // åŒ»é™¢è¾“å…¥
          Column() {
            Text('åŒ»é™¢')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333')
              .margin({ bottom: 10 })
            TextInput({
              text: this.editHospital,
              placeholder: 'è¯·è¾“å…¥åŒ»é™¢åç§°'
            })
              .width('100%')
              .height(48)
              .padding({ left: 16, right: 16 })
              .backgroundColor('#F8F9FA')
              .borderRadius(12)
              .fontSize(15)
              .onChange((value: string) => {
                this.editHospital = value;
              })
          }
          .width('100%')
          .margin({ bottom: 20 })

          // æ—¥æœŸè¾“å…¥
          Column() {
            Text('æ—¥æœŸ')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333')
              .margin({ bottom: 10 })
            TextInput({
              text: this.editDate,
              placeholder: 'æ ¼å¼: YYYY-MM-DD'
            })
              .width('100%')
              .height(48)
              .padding({ left: 16, right: 16 })
              .backgroundColor('#F8F9FA')
              .borderRadius(12)
              .fontSize(15)
              .onChange((value: string) => {
                this.editDate = value;
              })
          }
          .width('100%')
          .margin({ bottom: 20 })

          // å†…å®¹ç¼–è¾‘
          Column() {
            Text('å†…å®¹')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333')
              .margin({ bottom: 10 })
            TextArea({
              text: this.editContent,
              placeholder: 'è¯·è¾“å…¥æ¡£æ¡ˆå†…å®¹...'
            })
              .width('100%')
              .height(200)
              .padding(16)
              .backgroundColor('#F8F9FA')
              .borderRadius(12)
              .fontSize(15)
              .onChange((value: string) => {
                this.editContent = value;
              })
          }
          .width('100%')
          .margin({ bottom: 32 })

          // æ“ä½œæŒ‰é’®
          Row() {
            Button('å–æ¶ˆ', { type: ButtonType.Normal })
              .layoutWeight(1)
              .height(50)
              .backgroundColor('#F0F0F0')
              .fontColor('#333')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .borderRadius(25)
              .onClick(() => this.cancelEdit())

            Button('ä¿å­˜', { type: ButtonType.Normal })
              .layoutWeight(1)
              .height(50)
              .backgroundColor('#5FCCC4')
              .fontColor(Color.White)
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .borderRadius(25)
              .margin({ left: 12 })
              .onClick(() => this.saveEdit())
          }
          .width('100%')
        }
        .width('100%')
        .padding(24)
        .backgroundColor(Color.White)
        .borderRadius(20)
        .margin({ top: 16, left: 16, right: 16, bottom: 40 })
        .shadow({
          radius: 12,
          color: '#1F000000',
          offsetX: 0,
          offsetY: 4
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
  @Builder
  buildShareDialog() {
    // é®ç½©å±‚
    Column() {
      // ç‚¹å‡»é®ç½©å±‚å…³é—­å¼¹çª—
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0,0,0,0.5)')
    .onClick(() => this.closeShareDialog())
    .position({ x: 0, y: 0 })

    // å¼¹çª—å†…å®¹
    Column() {
      // å¼¹çª—æ ‡é¢˜
      Row() {
        Text('æˆæƒç åˆ†äº«')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
        Blank()
        Text('Ã—')
          .fontSize(24)
          .fontColor('#666')
          .onClick(() => this.closeShareDialog())
      }
      .width('100%')
      .padding({ bottom: 20 })

      // æ¡£æ¡ˆä¿¡æ¯
      if (this.selectedArchive) {
        Column() {
          Row() {
            Column() {
              Text(this.getTypeIcon(this.selectedArchive.type))
                .fontSize(24)
            }
            .margin({ right: 16 })

            Column() {
              Text(this.selectedArchive.title)
                .fontSize(16)
                .fontWeight(FontWeight.Medium)
                .margin({ bottom: 4 })
                .maxLines(2)
              Text(this.selectedArchive.hospital)
                .fontSize(14)
                .fontColor('#666')
            }
          }
          .width('100%')
          .padding({ bottom: 16 })
        }
      }

      // æˆæƒç å±•ç¤º
      Column() {
        Text('16ä½æˆæƒç ')
          .fontSize(14)
          .fontColor('#666')
          .margin({ bottom: 12 })

        if (this.shareCode) {
          Column() {
            Text(this.shareCode)
              .fontSize(22)
              .fontWeight(FontWeight.Bold)
              .fontColor('#5FCCC4')
              .textAlign(TextAlign.Center)
              .width('100%')
              .padding({ top: 16, bottom: 16 })
              .backgroundColor('#F0F7FF')
              .borderRadius(8)

            Text('æœ‰æ•ˆæœŸè‡³ï¼š' + this.shareExpireTime)
              .fontSize(12)
              .fontColor('#999')
              .margin({ top: 8 })
          }
        } else {
          Text('ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆæˆæƒç ')
            .fontSize(14)
            .fontColor('#999')
            .textAlign(TextAlign.Center)
            .width('100%')
            .padding(20)
            .backgroundColor('#F8F9FA')
            .borderRadius(8)
        }
      }
      .margin({ bottom: 24 })
      // æ“ä½œæŒ‰é’®
      Row() {
        if (!this.shareCode) {
          Button('ç”Ÿæˆæˆæƒç ', { type: ButtonType.Normal })
            .layoutWeight(1)
            .height(48)
            .backgroundColor('#5FCCC4')
            .fontColor(Color.White)
            .onClick(() => this.shareArchive())
        } else {
          // åªæœ‰ä¸€ä¸ª"é‡æ–°ç”Ÿæˆ"æŒ‰é’®
          Button('é‡æ–°ç”Ÿæˆ', { type: ButtonType.Normal })
            .width('100%')
            .height(48)
            .backgroundColor('#FF9800')
            .fontColor(Color.White)
            .onClick(() => this.regenerateShareCode())
        }
      }
      .width('100%')
    }
    .width('80%')
    .padding(24)
    .backgroundColor(Color.White)
    .borderRadius(16)
    .position({ x: '10%', y: '20%' })
    .zIndex(1000)
  }
  private getTypeIcon(type: string): string {
    // ç›´æ¥ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ
    if (type === 'é—¨è¯Šç—…å†') return 'ğŸ¥';
    if (type === 'æ£€æŸ¥æŠ¥å‘Š') return 'ğŸ”¬';
    if (type === 'ç”¨è¯å¤„æ–¹') return 'ğŸ’Š';
    if (type === 'ä¸“é¡¹æ¡£æ¡ˆ') return 'ğŸ“‹';
    return 'ğŸ“„';
  }
  // è¿›å…¥ç¼–è¾‘æ¨¡å¼
  private enterEditMode(record: HealthRecord) {
    this.selectedArchive = record;
    this.editTitle = record.title;
    this.editType = record.type;
    this.editHospital = record.hospital;
    this.editDate = record.date;
    this.editContent = record.content;
    this.currentTab = 2; // åˆ‡æ¢åˆ°ç¼–è¾‘é¡µ
  }

  // ä¿å­˜ç¼–è¾‘
  private async saveEdit() {
    if (!this.selectedArchive) return;

    // æ›´æ–°é€‰ä¸­çš„æ¡£æ¡ˆ
    this.selectedArchive.title = this.editTitle;
    this.selectedArchive.type = this.editType as 'é—¨è¯Šç—…å†' | 'æ£€æŸ¥æŠ¥å‘Š' | 'ç”¨è¯å¤„æ–¹' | 'ä¸“é¡¹æ¡£æ¡ˆ' | 'å…¶ä»–';
    this.selectedArchive.hospital = this.editHospital;
    this.selectedArchive.date = this.editDate;
    this.selectedArchive.content = this.editContent;

    // æ›´æ–°åˆ—è¡¨
    this.archiveList = this.archiveList.map((item: HealthRecord): HealthRecord =>
    item.id === this.selectedArchive!.id ? this.selectedArchive! : item
    );

    // ä¿å­˜åˆ°æœ¬åœ°
    await StorageHelper.saveArchiveList(this.archiveList);

    this.currentTab = 1; // è¿”å›è¯¦æƒ…é¡µ
    prompt.showToast({ message: 'ä¿å­˜æˆåŠŸ', duration: 2000 });
  }

  // å–æ¶ˆç¼–è¾‘
  private cancelEdit() {
    this.currentTab = 1; // è¿”å›è¯¦æƒ…é¡µ
  }

  // ============ åŠ å¯†åˆ†äº«æ–¹æ³• ============
  private generateShareCode(): string {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 16; i++) {
      if (i > 0 && i % 4 === 0) code += '-';
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return code;
  }

  private async shareArchive() {
    if (!this.selectedArchive) return;

    // ç”Ÿæˆæˆæƒç 
    this.shareCode = this.generateShareCode();

    // è®¾ç½®è¿‡æœŸæ—¶é—´
    const expireTime = new Date();
    expireTime.setHours(expireTime.getHours() + 24);
    this.shareExpireTime = expireTime.toLocaleString();

    // åˆ›å»ºAuthorizationCodeå¯¹è±¡ - æ·»åŠ ç±»å‹æ–­è¨€
    const authCodeData: AuthCodeData = {
      code: this.shareCode,
      recordIds: [this.selectedArchive.id],
      hospitalName: '',
      expireAt: expireTime.getTime(),
      createdAt: Date.now(),
      used: false
    };
    const authCode = new AuthorizationCode(authCodeData);

    // ä¿å­˜åˆ°åˆ—è¡¨
    this.authorizationCodes.push(authCode);

    // ä¿å­˜åˆ°æœ¬åœ°
    await StorageHelper.saveAuthorizationCodes(this.authorizationCodes);

    // æ˜¾ç¤ºå¼¹çª—
    this.showShareDialog = true;

    prompt.showToast({
      message: 'æˆæƒç å·²ç”Ÿæˆ',
      duration: 2000
    });
  }



  private closeShareDialog() {
    this.showShareDialog = false;
    this.shareCode = '';
    // å¯ä»¥é€‰æ‹©æ˜¯å¦æ¸…ç©ºç›®æ ‡åŒ»é™¢
    // this.targetHospital = '';
  }

  private viewAuthorizationCodes() {
    if (this.authorizationCodes.length === 0) {
      prompt.showToast({
        message: 'æš‚æ— ç”Ÿæˆçš„æˆæƒç ',
        duration: 2000
      });
      return;
    }
    // æ˜¾ç¤ºæˆæƒç ç®¡ç†å¼¹çª—
    this.showAuthCodeDialog = true;
  }

  // æ„å»ºæˆæƒç ç®¡ç†å¼¹çª—
  @Builder
  buildAuthCodeDialog() {
    // é®ç½©å±‚
    Column() {
    }
    .width('100%')
    .height('100%')
    .backgroundColor('rgba(0,0,0,0.5)')
    .onClick(() => this.closeAuthCodeDialog())
    .position({ x: 0, y: 0 })

    // å¼¹çª—å†…å®¹
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('æˆæƒç ç®¡ç†')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor('#1A1A1A')
        Blank()
        Text('Ã—')
          .fontSize(28)
          .fontColor('#666')
          .onClick(() => this.closeAuthCodeDialog())
      }
      .width('100%')
      .padding({ bottom: 20 })

      // ç»Ÿè®¡ä¿¡æ¯
      Row() {
        Text(`å…± ${this.authorizationCodes.length} ä¸ªæˆæƒç `)
          .fontSize(14)
          .fontColor('#666')
        Blank()
        Button('åˆ é™¤å·²è¿‡æœŸ', { type: ButtonType.Normal })
          .height(32)
          .fontSize(12)
          .backgroundColor('#FF9800')
          .fontColor(Color.White)
          .onClick(() => this.deleteExpiredCodes())
      }
      .width('100%')
      .margin({ bottom: 16 })

      // æˆæƒç åˆ—è¡¨
      if (this.authorizationCodes.length === 0) {
        Column() {
          Text('æš‚æ— æˆæƒç ')
            .fontSize(16)
            .fontColor('#999')
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
      } else {
        Scroll() {
          Column() {
            ForEach(this.authorizationCodes, (code: AuthorizationCode, index: number) => {
              this.buildAuthCodeItem(code, index)
            }, (code: AuthorizationCode) => code.code)
          }
          .width('100%')
        }
        .layoutWeight(1)
        .width('100%')
      }
    }
    .width('90%')
    .height('80%')
    .padding(24)
    .backgroundColor(Color.White)
    .borderRadius(20)
    .position({ x: '5%', y: '10%' })
    .zIndex(1000)
  }

  // æ„å»ºå•ä¸ªæˆæƒç é¡¹
  @Builder
  buildAuthCodeItem(code: AuthorizationCode, index: number) {
    Column() {
      Row() {
        Column() {
          Text(code.code)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1A1A1A')
            .margin({ bottom: 8 })

          Text(`æ¡£æ¡ˆï¼š${this.getRecordTitle(code.recordIds[0] || '')}`)
            .fontSize(13)
            .fontColor('#666')
            .margin({ bottom: 4 })

          Row() {
            Text('çŠ¶æ€ï¼š')
              .fontSize(12)
              .fontColor('#999')
            Text(code.isExpired() ? 'å·²è¿‡æœŸ' : code.used ? 'å·²ä½¿ç”¨' : 'å¯ç”¨')
              .fontSize(12)
              .fontColor(code.isExpired() ? '#FF9800' : code.used ? '#999' : '#5FCCC4')
              .fontWeight(FontWeight.Medium)
          }
          .margin({ bottom: 4 })

          Text(`æœ‰æ•ˆæœŸï¼š${new Date(code.expireAt).toLocaleString()}`)
            .fontSize(12)
            .fontColor('#999')
        }
        .alignItems(HorizontalAlign.Start)
        .layoutWeight(1)

        // åˆ é™¤æŒ‰é’®
        Button('åˆ é™¤', { type: ButtonType.Normal })
          .height(36)
          .fontSize(13)
          .backgroundColor('#F44336')
          .fontColor(Color.White)
          .borderRadius(18)
          .onClick(() => {
            this.deleteAuthCode(code.code);
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#F8F9FA')
    .borderRadius(12)
    .margin({ bottom: 12 })
  }

  // å…³é—­æˆæƒç ç®¡ç†å¼¹çª—
  private closeAuthCodeDialog() {
    this.showAuthCodeDialog = false;
  }

  // åˆ é™¤å•ä¸ªæˆæƒç 
  private async deleteAuthCode(code: string) {
    prompt.showDialog({
      title: 'ç¡®è®¤åˆ é™¤',
      message: `ç¡®å®šè¦åˆ é™¤æˆæƒç  ${code} å—ï¼Ÿ`,
      buttons: [
        {
          text: 'å–æ¶ˆ',
          color: '#666'
        },
        {
          text: 'åˆ é™¤',
          color: '#F44336'
        }
      ]
    }).then(async (result) => {
      if (result.index === 1) {
        // åˆ é™¤æˆæƒç 
        const beforeCount = this.authorizationCodes.length;
        this.authorizationCodes = this.authorizationCodes.filter(c => c.code !== code);
        const deletedCount = beforeCount - this.authorizationCodes.length;

        // ä¿å­˜åˆ°æœ¬åœ°
        await StorageHelper.saveAuthorizationCodes(this.authorizationCodes);

        if (deletedCount > 0) {
          prompt.showToast({
            message: 'æˆæƒç å·²åˆ é™¤',
            duration: 2000
          });

          // å¦‚æœåˆ é™¤åæ²¡æœ‰æˆæƒç äº†ï¼Œå…³é—­å¼¹çª—
          if (this.authorizationCodes.length === 0) {
            setTimeout(() => {
              this.closeAuthCodeDialog();
            }, 1500);
          }
        }
      }
    });
  }

  // è¾…åŠ©æ–¹æ³•ï¼šæ ¹æ®IDè·å–æ¡£æ¡ˆæ ‡é¢˜
  private getRecordTitle(recordId: string): string {
    const record: HealthRecord | undefined = this.archiveList.find((r: HealthRecord) => r.id === recordId);
    return record ? record.title : 'æœªçŸ¥æ¡£æ¡ˆ';
  }

  // ============ æ–°å¢ï¼šé‡æ–°ç”Ÿæˆæˆæƒç æ–¹æ³• ============
  private async regenerateShareCode() {
    if (!this.selectedArchive) return;

    // ç”Ÿæˆæ–°çš„æˆæƒç 
    this.shareCode = this.generateShareCode();

    // æ›´æ–°è¿‡æœŸæ—¶é—´
    const expireTime = new Date();
    expireTime.setHours(expireTime.getHours() + 24);
    this.shareExpireTime = expireTime.toLocaleString();

    // åˆ›å»ºæ–°çš„AuthorizationCodeå¯¹è±¡ - æ·»åŠ ç±»å‹æ–­è¨€
    const newAuthCodeData: AuthCodeData = {
      code: this.shareCode,
      recordIds: [this.selectedArchive.id],
      hospitalName: '',
      expireAt: expireTime.getTime(),
      createdAt: Date.now(),
      used: false
    };
    const newAuthCode = new AuthorizationCode(newAuthCodeData);

    // æ·»åŠ åˆ°åˆ—è¡¨
    this.authorizationCodes.push(newAuthCode);

    // ä¿å­˜åˆ°æœ¬åœ°
    await StorageHelper.saveAuthorizationCodes(this.authorizationCodes);

    prompt.showToast({
      message: 'å·²é‡æ–°ç”Ÿæˆæˆæƒç ',
      duration: 2000
    });
  }
  // åˆ é™¤å·²è¿‡æœŸçš„æˆæƒç 
  private async deleteExpiredCodes() {
    const beforeCount = this.authorizationCodes.length;

    // è¿‡æ»¤æ‰å·²è¿‡æœŸçš„
    this.authorizationCodes = this.authorizationCodes.filter(code => !code.isExpired());

    const deletedCount = beforeCount - this.authorizationCodes.length;

    // ä¿å­˜åˆ°æœ¬åœ°
    await StorageHelper.saveAuthorizationCodes(this.authorizationCodes);

    if (deletedCount > 0) {
      prompt.showToast({
        message: `å·²åˆ é™¤ ${deletedCount} ä¸ªè¿‡æœŸæˆæƒç `,
        duration: 2000
      });

      // å¯é€‰ï¼šè‡ªåŠ¨é‡æ–°æ‰“å¼€ç®¡ç†é¡µé¢
      setTimeout(() => {
        this.viewAuthorizationCodes();
      }, 1500);
    } else {
      prompt.showToast({
        message: 'æ²¡æœ‰å·²è¿‡æœŸçš„æˆæƒç ',
        duration: 2000
      });
    }
  }
}